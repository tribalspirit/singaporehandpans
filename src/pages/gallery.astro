---
import { getStoryblokClient } from '../lib/storyblok';
import BaseLayout from '../layouts/BaseLayout.astro';
import GalleryGrid from '../components/GalleryGrid';
import AlbumCard from '../components/gallery/AlbumCard.astro';
import CMSFallback from '../components/CMSFallback.astro';
import { normalizeTags } from '../utils/tags';
import { transformAlbum } from '../lib/galleryApi';
import type { GalleryAlbumStory } from '../types/gallery';

export const prerender = false;

interface LegacyGalleryItem {
  id: string;
  uuid: string;
  name: string;
  slug: string;
  content: {
    component: string;
    title: string;
    media?: {
      filename: string;
      alt?: string;
    };
    description?: string;
    tags?: string | string[];
    alt_text?: string;
    photographer?: string;
    featured?: boolean;
    sort_order?: number;
  };
}

let albums: ReturnType<typeof transformAlbum>[] = [];
let legacyItems: LegacyGalleryItem[] = [];
let error = null;

const runtime = Astro.locals.runtime;
const token = runtime?.env?.STORYBLOK_TOKEN ?? import.meta.env.STORYBLOK_TOKEN;

try {
  const storyblokApi = getStoryblokClient(token);
  const storyblokVersion = import.meta.env.PROD ? 'published' : 'draft';

  // Try fetching albums first
  const albumResponse = await storyblokApi.get('cdn/stories', {
    version: storyblokVersion,
    starts_with: 'gallery/albums/',
    content_type: 'gallery_album',
    per_page: 100,
    resolve_assets: 1,
  });

  const albumStories: GalleryAlbumStory[] = albumResponse.data.stories || [];

  if (albumStories.length > 0) {
    // Get media counts for each album via lightweight queries
    const albumsWithCounts = await Promise.all(
      albumStories.map(async (story) => {
        // Album story is inside its folder, e.g. gallery/albums/workshop-moments/workshop-moments
        // Media siblings are at gallery/albums/workshop-moments/*
        const folderPath = story.full_slug.substring(
          0,
          story.full_slug.lastIndexOf('/')
        );
        try {
          const mediaResponse = await storyblokApi.get('cdn/stories', {
            version: storyblokVersion,
            starts_with: `${folderPath}/`,
            content_type: 'gallery_media',
            per_page: 1,
            sort_by: 'content.sort_order:asc',
            resolve_assets: 1,
          });
          const itemCount =
            mediaResponse.total || mediaResponse.data?.stories?.length || 0;
          // Use first media item's image as fallback album cover
          const firstMedia = mediaResponse.data?.stories?.[0];
          const fallbackCover = firstMedia?.content?.media?.filename || '';
          return transformAlbum(story, itemCount, fallbackCover);
        } catch {
          return transformAlbum(story, 0);
        }
      })
    );

    // Sort: featured first, then by sort_order, then by date
    albums = albumsWithCounts.sort((a, b) => {
      if (a.featured !== b.featured) return a.featured ? -1 : 1;
      if (a.sortOrder !== b.sortOrder) return a.sortOrder - b.sortOrder;
      if (a.date && b.date)
        return new Date(b.date).getTime() - new Date(a.date).getTime();
      return 0;
    });
  } else {
    // Fallback: fetch legacy gallery_item stories
    const legacyResponse = await storyblokApi.get('cdn/stories', {
      version: storyblokVersion,
      starts_with: 'gallery/',
      is_startpage: false,
      per_page: 100,
      resolve_assets: 1,
    });

    legacyItems = (legacyResponse.data.stories || [])
      .filter(
        (story: LegacyGalleryItem) => story.content.component === 'gallery_item'
      )
      .sort((a: LegacyGalleryItem, b: LegacyGalleryItem) => {
        const orderA = a.content.sort_order || 999;
        const orderB = b.content.sort_order || 999;
        return orderA - orderB;
      });
  }
} catch (err) {
  console.error('Failed to fetch gallery content:', err);
  error = err;
}

// Transform legacy items for GalleryGrid (backward compat)
const transformedLegacyItems = legacyItems.map((item) => ({
  id: item.uuid,
  title: item.content.title,
  media: item.content.media,
  description: item.content.description,
  tags: normalizeTags(item.content.tags),
  alt_text: item.content.alt_text,
  photographer: item.content.photographer,
  featured: item.content.featured,
}));

const hasAlbums = albums.length > 0;
const featuredAlbums = albums.filter((a) => a.featured);
const regularAlbums = albums.filter((a) => !a.featured);

const pageTitle = 'Gallery';
const pageDescription =
  'Explore our collection of handpan moments - workshops, performances, instruments, and community gatherings at Singapore Handpan Studio.';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="gallery-page">
    <section class="hero-section">
      <div class="container">
        <h1 class="page-title">Gallery</h1>
        <p class="page-subtitle">
          Explore moments from our studio, workshops, and community gatherings
        </p>
      </div>
    </section>

    <section class="gallery-section">
      <div class="container">
        {
          error ? (
            <CMSFallback
              message="Unable to load gallery content. Please try again later."
              showRetry={true}
            />
          ) : hasAlbums ? (
            <>
              {featuredAlbums.length > 0 && (
                <div class="featured-albums">
                  <h2 class="section-title">Featured Albums</h2>
                  <div class="albums-grid">
                    {featuredAlbums.map((album) => (
                      <AlbumCard album={album} />
                    ))}
                  </div>
                </div>
              )}

              <div class="all-albums">
                {featuredAlbums.length > 0 && (
                  <h2 class="section-title">All Albums</h2>
                )}
                <div class="albums-grid">
                  {regularAlbums.map((album) => (
                    <AlbumCard album={album} />
                  ))}
                </div>
              </div>
            </>
          ) : legacyItems.length === 0 ? (
            <div class="empty-state">
              <p>No gallery items available yet. Check back soon!</p>
            </div>
          ) : (
            <GalleryGrid items={transformedLegacyItems} client:load />
          )
        }
      </div>
    </section>
  </main>
</BaseLayout>

<style lang="scss">
  .gallery-page {
    min-height: 100vh;
  }

  .hero-section {
    background: linear-gradient(
      135deg,
      var(--color-primary-light) 0%,
      var(--color-accent-light) 100%
    );
    padding: var(--space-16) 0 var(--space-12);
    text-align: center;

    @media (max-width: 768px) {
      padding: var(--space-12) 0 var(--space-8);
    }
  }

  .page-title {
    font-size: var(--font-size-4xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-4);
    line-height: var(--line-height-tight);

    @media (min-width: 768px) {
      font-size: var(--font-size-5xl);
    }
  }

  .page-subtitle {
    font-size: var(--font-size-lg);
    color: var(--color-gray-700);
    max-width: 600px;
    margin: 0 auto;
    line-height: var(--line-height-relaxed);

    @media (min-width: 768px) {
      font-size: var(--font-size-xl);
    }
  }

  .gallery-section {
    padding: var(--space-16) 0;
    background: var(--color-gray-50);

    @media (max-width: 768px) {
      padding: var(--space-12) 0;
    }
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--space-6);

    @media (max-width: 768px) {
      padding: 0 var(--space-4);
    }
  }

  .section-title {
    font-size: var(--font-size-2xl);
    font-weight: var(--font-weight-bold);
    color: var(--color-gray-900);
    margin-bottom: var(--space-8);
  }

  .featured-albums {
    margin-bottom: var(--space-16);
  }

  .albums-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
    gap: var(--spacing-lg);

    @media (max-width: 768px) {
      grid-template-columns: 1fr;
      gap: var(--spacing-md);
    }
  }

  .empty-state {
    text-align: center;
    padding: var(--space-16);
    color: var(--color-gray-600);
    font-size: var(--font-size-lg);
  }
</style>
