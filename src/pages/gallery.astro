---
import { useStoryblokApi } from '@storyblok/astro';
import BaseLayout from '../layouts/BaseLayout.astro';
import GalleryGrid from '../components/GalleryGrid';
import CMSFallback from '../components/CMSFallback.astro';
import { normalizeTags } from '../utils/tags';

interface GalleryItem {
  id: string;
  uuid: string;
  name: string;
  slug: string;
  content: {
    component: string;
    title: string;
    media?: {
      filename: string;
      alt?: string;
    };
    description?: string;
    tags?: string | string[];
    alt_text?: string;
    photographer?: string;
    featured?: boolean;
    sort_order?: number;
  };
}

let galleryItems: GalleryItem[] = [];
let error = null;

try {
  const storyblokApi = useStoryblokApi();
  const response = await storyblokApi.get('cdn/stories', {
    version: import.meta.env.DEV ? 'draft' : 'published',
    starts_with: 'gallery/',
    is_startpage: false,
    per_page: 100,
    resolve_assets: 1,
  });

  galleryItems = response.data.stories
    .filter((story: GalleryItem) => story.content.component === 'gallery_item')
    .sort((a: GalleryItem, b: GalleryItem) => {
      const orderA = a.content.sort_order || 999;
      const orderB = b.content.sort_order || 999;
      return orderA - orderB;
    });
} catch (err) {
  console.error('Failed to fetch gallery items:', err);
  error = err;
}

const transformedItems = galleryItems.map((item) => ({
  id: item.uuid,
  title: item.content.title,
  media: item.content.media,
  description: item.content.description,
  tags: normalizeTags(item.content.tags),
  alt_text: item.content.alt_text,
  photographer: item.content.photographer,
  featured: item.content.featured,
}));

const pageTitle = 'Gallery - Singapore Handpan Studio';
const pageDescription =
  'Explore our collection of handpan moments - workshops, performances, instruments, and community gatherings at Singapore Handpan Studio.';
---

<BaseLayout title={pageTitle} description={pageDescription}>
  <main class="gallery-page">
    <section class="hero-section">
      <div class="container">
        <h1 class="page-title">Gallery</h1>
        <p class="page-subtitle">
          Explore moments from our studio, workshops, and community gatherings
        </p>
      </div>
    </section>

    <section class="gallery-section">
      <div class="container">
        {error ? (
          <CMSFallback
            message="Unable to load gallery content. Please try again later."
            showRetry={true}
          />
        ) : galleryItems.length === 0 ? (
          <div class="empty-state">
            <p>No gallery items available yet. Check back soon!</p>
          </div>
        ) : (
          <GalleryGrid items={transformedItems} client:load />
        )}
      </div>
    </section>
  </main>
</BaseLayout>

<style lang="scss">
  @use 'src/styles/tokens.scss';

  .gallery-page {
    min-height: 100vh;
  }

  .hero-section {
    background: linear-gradient(
      135deg,
      var(--color-primary-light) 0%,
      var(--color-accent-light) 100%
    );
    padding: var(--spacing-4xl) 0 var(--spacing-3xl);
    text-align: center;

    @media (max-width: 768px) {
      padding: var(--spacing-3xl) 0 var(--spacing-2xl);
    }
  }

  .page-title {
    font-size: clamp(2.5rem, 5vw, 4rem);
    font-weight: var(--font-weight-bold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
    line-height: 1.2;
  }

  .page-subtitle {
    font-size: clamp(1.125rem, 2vw, 1.5rem);
    color: var(--color-text-secondary);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }

  .gallery-section {
    padding: var(--spacing-4xl) 0;
    background: var(--color-background);

    @media (max-width: 768px) {
      padding: var(--spacing-3xl) 0;
    }
  }

  .container {
    max-width: 1400px;
    margin: 0 auto;
    padding: 0 var(--spacing-lg);

    @media (max-width: 768px) {
      padding: 0 var(--spacing-md);
    }
  }

  .empty-state {
    text-align: center;
    padding: var(--spacing-4xl);
    color: var(--color-text-secondary);
    font-size: var(--font-size-lg);
  }
</style>

