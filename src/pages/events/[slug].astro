---
import BaseLayout from '../../layouts/BaseLayout.astro';
import EventDetail from '../../components/EventDetail.astro';
import { getStoryblokClient } from '../../lib/storyblok';
import type { EventStory } from '../../types/event';

export const prerender = false;

const EVENT_DURATION_MS = 2 * 60 * 60 * 1000;
const PRICE_SANITIZE_REGEX = /[^0-9.]/g;
const FREE_LABEL = 'Free';
const PRICE_CURRENCY = 'SGD';

const { slug } = Astro.params;

let event: EventStory | undefined;

try {
  const runtime = Astro.locals.runtime;
  const token =
    runtime?.env?.STORYBLOK_TOKEN ?? import.meta.env.STORYBLOK_TOKEN;
  const storyblokApi = getStoryblokClient(token);
  const storyblokVersion = import.meta.env.PROD ? 'published' : 'draft';

  const { data } = await storyblokApi.get(`cdn/stories/events/${slug}`, {
    version: storyblokVersion,
  });

  event = data?.story;
} catch (error) {
  console.error('Event [slug]: Failed to load from Storyblok', error);
}

if (!event) {
  return Astro.redirect('/events');
}

const eventDate = new Date(event.content.date);
const eventEndDate = new Date(eventDate.getTime() + EVENT_DURATION_MS);

const priceValue =
  event.content.price && event.content.price !== FREE_LABEL
    ? event.content.price.replace(PRICE_SANITIZE_REGEX, '')
    : '0';

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Event',
  name: event.content.title,
  description: event.content.description,
  startDate: event.content.date,
  endDate: eventEndDate.toISOString(),
  location: {
    '@type': 'Place',
    name: event.content.location,
    address: {
      '@type': 'PostalAddress',
      addressLocality: 'Singapore',
      addressCountry: 'SG',
    },
  },
  organizer: {
    '@type': 'Organization',
    name: 'Singapore Handpan Studio',
    url: Astro.site?.toString(),
  },
  offers: event.content.price
    ? {
        '@type': 'Offer',
        price: priceValue,
        priceCurrency: PRICE_CURRENCY,
        availability:
          event.content.sold_out_override ||
          event.content.availability_status === 'sold_out'
            ? 'https://schema.org/SoldOut'
            : event.content.availability_status === 'few_spots'
              ? 'https://schema.org/LimitedAvailability'
              : 'https://schema.org/InStock',
        url: event.content.booking_url || `${Astro.site}events/${event.slug}`,
      }
    : undefined,
  image: event.content.image?.filename,
  eventStatus: 'https://schema.org/EventScheduled',
  eventAttendanceMode: 'https://schema.org/OfflineEventAttendanceMode',
};

const seoTitle =
  event.content.seo_title ||
  `${event.content.title} - Singapore Handpan Studio`;
const seoDescription =
  event.content.seo_description || event.content.description;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  canonical={`${Astro.site}events/${event.slug}/`}
>
  <script
    type="application/ld+json"
    set:html={JSON.stringify(structuredData)}
    slot="head"
  />
  <main class="event-detail-page">
    <div class="container">
      <nav class="breadcrumb">
        <a href="/">Home</a>
        <span class="separator">›</span>
        <a href="/events">Events</a>
        <span class="separator">›</span>
        <span class="current">{event.content.title}</span>
      </nav>

      <EventDetail event={event} />
    </div>
  </main>
</BaseLayout>

<style lang="scss">
  @use 'src/styles/tokens.scss';

  .event-detail-page {
    min-height: calc(100vh - var(--header-height) - var(--footer-height));
    padding: var(--spacing-lg) 0;

    .container {
      max-width: var(--max-width);
      margin: 0 auto;
      padding: 0 var(--spacing-md);
    }
  }

  .breadcrumb {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);
    margin-bottom: var(--spacing-xl);
    font-size: var(--font-size-sm);
    color: var(--color-text-secondary);

    a {
      color: var(--color-primary);
      text-decoration: none;

      &:hover {
        text-decoration: underline;
      }
    }

    .separator {
      color: var(--color-text-tertiary);
    }

    .current {
      color: var(--color-text-primary);
      font-weight: var(--font-weight-medium);
    }
  }

  @media (max-width: 768px) {
    .breadcrumb {
      flex-wrap: wrap;
      gap: var(--spacing-xs);

      .current {
        flex: 1 0 100%;
        margin-top: var(--spacing-xs);
      }
    }
  }
</style>
