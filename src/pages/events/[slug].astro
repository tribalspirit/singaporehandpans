---
import { useStoryblokApi } from '@storyblok/astro';
import BaseLayout from '../../layouts/BaseLayout.astro';
import CMSFallback from '../../components/CMSFallback.astro';
import EventDetail from '../../components/EventDetail.astro';

const EVENT_DURATION_MS = 2 * 60 * 60 * 1000;
const PRICE_SANITIZE_REGEX = /[^0-9.]/g;
const FREE_LABEL = 'Free';
const PRICE_CURRENCY = 'SGD';

interface EventStory {
  id: string;
  name: string;
  slug: string;
  content: {
    title: string;
    description: string;
    date: string;
    location: string;
    price?: string;
    booking_url?: string;
    image?: { filename: string; alt?: string };
    tags?: string | string[];
    status?: string;
    max_participants?: number;
    seo_title?: string;
    seo_description?: string;
  };
}

const FALLBACK_EVENTS: EventStory[] = [
  {
    id: 'fallback-1',
    name: 'Beginner Handpan Workshop',
    slug: 'beginner-handpan-workshop',
    content: {
      title: 'Beginner Handpan Workshop',
      description:
        'Join us for an introduction to the beautiful world of handpan music. Perfect for complete beginners who want to learn the basics in a supportive environment.',
      date: '2024-03-15T19:00:00Z',
      location: 'Singapore Handpan Studio',
      price: 'S$120',
      booking_url:
        import.meta.env.PUBLIC_CALENDLY_WORKSHOP_URL ||
        'https://calendly.com/singaporehandpan/workshop',
      tags: ['workshop', 'beginner'],
      status: 'upcoming',
      max_participants: 6,
      seo_title: 'Beginner Handpan Workshop Singapore - Learn Handpan Music',
      seo_description:
        'Join our beginner-friendly handpan workshop in Singapore. Learn the basics of this beautiful instrument with experienced instructors.',
    },
  },
  {
    id: 'fallback-2',
    name: 'Community Handpan Gathering',
    slug: 'community-handpan-gathering',
    content: {
      title: 'Community Handpan Gathering',
      description:
        'A relaxed gathering for handpan enthusiasts to play together, share music, and connect with fellow musicians in Singapore.',
      date: '2024-03-22T15:00:00Z',
      location: 'Singapore Handpan Studio',
      price: 'Free',
      tags: ['community', 'gathering'],
      status: 'upcoming',
      max_participants: 15,
      seo_title: 'Community Handpan Gathering Singapore - Free Event',
      seo_description:
        'Join fellow handpan enthusiasts for a free community gathering. Share music and connect with other musicians in Singapore.',
    },
  },
];

export async function getStaticPaths() {
  try {
    const storyblokApi = useStoryblokApi();
    if (!storyblokApi) {
      throw new Error('Storyblok API not initialized');
    }

    const storyblokVersion = import.meta.env.PROD ? 'published' : 'draft';

    const { data } = await storyblokApi.get('cdn/stories', {
      starts_with: 'events/',
      content_type: 'event',
      version: storyblokVersion,
    });

    const stories: EventStory[] = data?.stories || [];

    if (stories.length > 0) {
      return stories.map((story) => ({
        params: { slug: story.slug },
        props: { event: story, cmsError: false },
      }));
    }

    return FALLBACK_EVENTS.map((event) => ({
      params: { slug: event.slug },
      props: { event, cmsError: true },
    }));
  } catch (error) {
    console.error('Event [slug]: Failed to load from Storyblok', error);
    return FALLBACK_EVENTS.map((event) => ({
      params: { slug: event.slug },
      props: { event, cmsError: true },
    }));
  }
}

const { event, cmsError } = Astro.props as { event?: EventStory; cmsError?: boolean };

if (!event) {
  return Astro.redirect('/events');
}

const eventDate = new Date(event.content.date);
const eventEndDate = new Date(eventDate.getTime() + EVENT_DURATION_MS);

const priceValue =
  event.content.price && event.content.price !== FREE_LABEL
    ? event.content.price.replace(PRICE_SANITIZE_REGEX, '')
    : '0';

const structuredData = {
  '@context': 'https://schema.org',
  '@type': 'Event',
  name: event.content.title,
  description: event.content.description,
  startDate: event.content.date,
  endDate: eventEndDate.toISOString(),
  location: {
    '@type': 'Place',
    name: event.content.location,
    address: {
      '@type': 'PostalAddress',
      addressLocality: 'Singapore',
      addressCountry: 'SG',
    },
  },
  organizer: {
    '@type': 'Organization',
    name: 'Singapore Handpan Studio',
    url: Astro.site?.toString(),
  },
  offers: event.content.price
    ? {
        '@type': 'Offer',
        price: priceValue,
        priceCurrency: PRICE_CURRENCY,
        availability: 'https://schema.org/InStock',
        url: event.content.booking_url || `${Astro.site}events/${event.slug}`,
      }
    : undefined,
  image: event.content.image?.filename,
  eventStatus: 'https://schema.org/EventScheduled',
  eventAttendanceMode: 'https://schema.org/OfflineEventAttendanceMode',
};

const seoTitle = event.content.seo_title || `${event.content.title} - Singapore Handpan Studio`;
const seoDescription = event.content.seo_description || event.content.description;
---

<BaseLayout
  title={seoTitle}
  description={seoDescription}
  canonical={`${Astro.site}events/${event.slug}/`}
>
  <main class="event-detail-page">
    {cmsError && <CMSFallback type="events" />}

    <div class="container">
      <nav class="breadcrumb">
        <a href="/">Home</a>
        <span class="separator">›</span>
        <a href="/events">Events</a>
        <span class="separator">›</span>
        <span class="current">{event.content.title}</span>
      </nav>

      <EventDetail event={event} />
    </div>
  </main>
</BaseLayout>

<style lang="scss">
@use "src/styles/tokens.scss";

.event-detail-page {
  min-height: calc(100vh - var(--header-height) - var(--footer-height));
  padding: var(--spacing-lg) 0;

  .container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--spacing-md);
  }
}

.breadcrumb {
  display: flex;
  align-items: center;
  gap: var(--spacing-sm);
  margin-bottom: var(--spacing-xl);
  font-size: var(--font-size-sm);
  color: var(--color-text-secondary);

  a {
    color: var(--color-primary);
    text-decoration: none;

    &:hover {
      text-decoration: underline;
    }
  }

  .separator {
    color: var(--color-text-tertiary);
  }

  .current {
    color: var(--color-text-primary);
    font-weight: var(--font-weight-medium);
  }
}

@media (max-width: 768px) {
  .breadcrumb {
    flex-wrap: wrap;
    gap: var(--spacing-xs);

    .current {
      flex: 1 0 100%;
      margin-top: var(--spacing-xs);
    }
  }
}
</style>
