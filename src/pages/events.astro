---
import BaseLayout from '../layouts/BaseLayout.astro';
import EventCard from '../components/EventCard.astro';
import CMSFallback from '../components/CMSFallback.astro';
import { useStoryblokApi } from '@storyblok/astro';

const FALLBACK_EVENTS = [
  {
    id: 'fallback-1',
    name: 'Beginner Handpan Workshop',
    slug: 'beginner-handpan-workshop',
    content: {
      title: 'Beginner Handpan Workshop',
      description: 'Join us for an introduction to the beautiful world of handpan music. Perfect for complete beginners who want to learn the basics in a supportive environment.',
      date: '2024-03-15T19:00:00Z',
      location: 'Singapore Handpan Studio',
      price: 'S$120',
      booking_url: import.meta.env.PUBLIC_CALENDLY_WORKSHOP_URL || 'https://calendly.com/singaporehandpan/workshop',
      tags: ['workshop', 'beginner'],
      status: 'upcoming',
      max_participants: 6,
      seo_title: 'Beginner Handpan Workshop Singapore - Learn Handpan Music',
      seo_description: 'Join our beginner-friendly handpan workshop in Singapore. Learn the basics of this beautiful instrument with experienced instructors.'
    }
  },
  {
    id: 'fallback-2',
    name: 'Community Handpan Gathering',
    slug: 'community-handpan-gathering',
    content: {
      title: 'Community Handpan Gathering',
      description: 'A relaxed gathering for handpan enthusiasts to play together, share music, and connect with fellow musicians in Singapore.',
      date: '2024-03-22T15:00:00Z',
      location: 'Singapore Handpan Studio',
      price: 'Free',
      tags: ['community', 'gathering'],
      status: 'upcoming',
      max_participants: 15,
      seo_title: 'Community Handpan Gathering Singapore - Free Event',
      seo_description: 'Join fellow handpan enthusiasts for a free community gathering. Share music and connect with other musicians in Singapore.'
    }
  }
];

let events = [];
let cmsError = false;

// Fetch from Storyblok - token is configured in astro.config.mjs integration
try {
  const storyblokApi = useStoryblokApi();
  // Use 'published' for production builds, 'draft' for development preview
  const storyblokVersion = import.meta.env.PROD ? 'published' : 'draft';
  
  const { data } = await storyblokApi.get('cdn/stories', {
    starts_with: 'events/',
    content_type: 'event',
    sort_by: 'content.date:desc',
    version: storyblokVersion,
    resolve_assets: 1,  // Resolve asset fields (images) properly
    cv: Date.now()  // Cache-busting parameter to ensure fresh data
  });
  
  if (data?.stories && data.stories.length > 0) {
    events = data.stories;
    cmsError = false;
  } else {
    // No events in CMS - use fallback events
    cmsError = true;
    events = FALLBACK_EVENTS;
  }
} catch (error) {
  cmsError = true;
  events = FALLBACK_EVENTS;
}

// Separate upcoming and past events
const now = new Date();
const upcomingEvents = events.filter(event => {
  const eventDate = new Date(event.content.date);
  return eventDate >= now;
}).sort((a, b) => new Date(a.content.date) - new Date(b.content.date));

const pastEvents = events.filter(event => {
  const eventDate = new Date(event.content.date);
  return eventDate < now;
}).sort((a, b) => new Date(b.content.date) - new Date(a.content.date));

const seoTitle = 'Events - Singapore Handpan Studio | Workshops & Community Gatherings';
const seoDescription = 'Join our handpan workshops, community gatherings, and special events in Singapore. Learn from experienced instructors and connect with fellow musicians.';
---

<BaseLayout 
  title={seoTitle}
  description={seoDescription}
  canonical={`${Astro.site}events/`}
>
  <main class="events-page">
    {cmsError && <CMSFallback type="events" />}
    
    <div class="container">
      <header class="page-header">
        <h1>Events & Workshops</h1>
        <p class="page-subtitle">
          Join our community of handpan enthusiasts through workshops, performances, and gatherings. 
          All skill levels welcome!
        </p>
      </header>

      {upcomingEvents.length > 0 && (
        <section class="events-section">
          <h2>Upcoming Events</h2>
          <div class="events-grid">
            {upcomingEvents.map(event => (
              <EventCard event={event} />
            ))}
          </div>
        </section>
      )}

      {pastEvents.length > 0 && (
        <section class="events-section">
          <h2>Past Events</h2>
          <div class="events-grid">
            {pastEvents.map(event => (
              <EventCard event={event} isPast={true} />
            ))}
          </div>
        </section>
      )}

      {events.length === 0 && (
        <section class="no-events">
          <h2>No Events Available</h2>
          <p>
            We're currently planning our next events. Check back soon or 
            <a href="/contacts">contact us</a> to stay updated!
          </p>
        </section>
      )}
    </div>
  </main>
</BaseLayout>

<style lang="scss">
@use "src/styles/tokens.scss";

.events-page {
  min-height: calc(100vh - var(--header-height) - var(--footer-height));
  padding: var(--spacing-xl) 0;

  .container {
    max-width: var(--max-width);
    margin: 0 auto;
    padding: 0 var(--spacing-md);
  }
}

.page-header {
  text-align: center;
  margin-bottom: var(--spacing-2xl);

  h1 {
    font-size: var(--font-size-xxl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-bottom: var(--spacing-md);
  }

  .page-subtitle {
    font-size: var(--font-size-lg);
    color: var(--color-text-secondary);
    max-width: 600px;
    margin: 0 auto;
    line-height: 1.6;
  }
}

.events-section {
  margin-bottom: var(--spacing-2xl);

  h2 {
    font-size: var(--font-size-xl);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-lg);
    padding-bottom: var(--spacing-sm);
    border-bottom: 2px solid var(--color-accent);
  }
}

.events-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
  gap: var(--spacing-lg);
  
  @media (max-width: 768px) {
    grid-template-columns: 1fr;
    gap: var(--spacing-md);
  }
}

.no-events {
  text-align: center;
  padding: var(--spacing-2xl) var(--spacing-lg);
  background: var(--color-surface);
  border-radius: var(--border-radius-lg);
  border: 1px solid var(--color-border);

  h2 {
    font-size: var(--font-size-xl);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
  }

  p {
    color: var(--color-text-secondary);
    font-size: var(--font-size-md);
    
    a {
      color: var(--color-primary);
      text-decoration: none;
      font-weight: var(--font-weight-semibold);
      
      &:hover {
        text-decoration: underline;
      }
    }
  }
}
</style>
