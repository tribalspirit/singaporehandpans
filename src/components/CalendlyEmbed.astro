---
export interface Props {
  url: string;
  height?: string;
  hideEventTypeDetails?: boolean;
  hideLandingPageDetails?: boolean;
  primaryColor?: string;
  textColor?: string;
}

const { 
  url, 
  height = '630px',
  hideEventTypeDetails = import.meta.env.PUBLIC_CALENDLY_HIDE_EVENT_TYPE_DETAILS === 'true' ? true : false,
  hideLandingPageDetails = import.meta.env.PUBLIC_CALENDLY_HIDE_LANDING_PAGE_DETAILS === 'true' ? true : true,
  primaryColor = import.meta.env.PUBLIC_CALENDLY_PRIMARY_COLOR || 'D4A574',
  textColor = import.meta.env.PUBLIC_CALENDLY_TEXT_COLOR || '2C3E50'
} = Astro.props;

// Extract the Calendly username/event from the URL
const calendlyMatch = url.match(/calendly\.com\/([^\/]+)(?:\/([^\/\?]+))?/);
const calendlyUser = calendlyMatch?.[1] || '';
const calendlyEvent = calendlyMatch?.[2] || '';

// Build the embed URL with parameters
const embedParams = new URLSearchParams({
  hide_event_type_details: hideEventTypeDetails ? '1' : '0',
  hide_landing_page_details: hideLandingPageDetails ? '1' : '0',
  primary_color: primaryColor.replace('#', ''),
  text_color: textColor.replace('#', '')
});

const embedUrl = `https://calendly.com/${calendlyUser}${calendlyEvent ? `/${calendlyEvent}` : ''}?${embedParams.toString()}`;

// Generate a unique ID for this embed
const embedId = `calendly-embed-${Math.random().toString(36).substr(2, 9)}`;
---

<div class="calendly-embed-wrapper">
  <div 
    class="calendly-inline-widget" 
    data-url={embedUrl}
    style={`min-width:320px;height:${height};`}
    id={embedId}
  >
    <!-- Fallback content while Calendly loads -->
    <div class="calendly-loading">
      <div class="loading-spinner"></div>
      <p>Loading booking calendar...</p>
      <noscript>
        <p>
          JavaScript is required to load the booking calendar. 
          <a href={url} target="_blank" rel="noopener noreferrer">
            Click here to book directly on Calendly
          </a>
        </p>
      </noscript>
    </div>
  </div>

  <!-- Fallback link for users with JavaScript disabled or embed issues -->
  <div class="calendly-fallback">
    <p>Having trouble with the booking calendar?</p>
    <a 
      href={url} 
      target="_blank" 
      rel="noopener noreferrer"
      class="calendly-fallback-link"
    >
      Book directly on Calendly
    </a>
  </div>
</div>

<!-- Calendly embed script -->
<script>
  // Load Calendly widget script if not already loaded
  if (!window.Calendly) {
    const script = document.createElement('script');
    script.src = 'https://assets.calendly.com/assets/external/widget.js';
    script.async = true;
    document.head.appendChild(script);
    
    script.onload = () => {
      // Initialize all Calendly widgets on the page
      if (window.Calendly) {
        window.Calendly.initInlineWidget({
          url: document.querySelector(`#${embedId}`).dataset.url
        });
      }
    };
  } else {
    // Calendly is already loaded, initialize this widget
    window.Calendly.initInlineWidget({
      url: document.querySelector(`#${embedId}`).dataset.url
    });
  }

  // Hide fallback content once Calendly loads
  const checkCalendlyLoaded = setInterval(() => {
    const widget = document.querySelector(`#${embedId} .calendly-spinner`);
    if (widget || document.querySelector(`#${embedId} iframe`)) {
      const fallback = document.querySelector(`#${embedId} .calendly-loading`);
      if (fallback) {
        fallback.style.display = 'none';
      }
      clearInterval(checkCalendlyLoaded);
    }
  }, 500);

  // Timeout fallback after 10 seconds
  setTimeout(() => {
    const loading = document.querySelector(`#${embedId} .calendly-loading`);
    const fallback = document.querySelector('.calendly-fallback');
    if (loading && loading.style.display !== 'none') {
      loading.innerHTML = '<p>Unable to load booking calendar. Please use the link below.</p>';
      if (fallback) {
        fallback.style.display = 'block';
      }
    }
  }, 10000);
</script>

<style lang="scss">
@use "src/styles/tokens.scss";

.calendly-embed-wrapper {
  position: relative;
  width: 100%;
  margin: var(--spacing-md) 0;
}

.calendly-inline-widget {
  border: 1px solid var(--color-border);
  border-radius: var(--border-radius-md);
  overflow: hidden;
  background: var(--color-surface);
  position: relative;
}

.calendly-loading {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  height: 400px;
  padding: var(--spacing-lg);
  text-align: center;

  .loading-spinner {
    width: 40px;
    height: 40px;
    border: 3px solid var(--color-border);
    border-top: 3px solid var(--color-primary);
    border-radius: 50%;
    animation: spin 1s linear infinite;
    margin-bottom: var(--spacing-md);
  }

  p {
    color: var(--color-text-secondary);
    margin: 0;
    font-size: var(--font-size-md);
  }

  noscript p {
    margin-top: var(--spacing-md);
    padding: var(--spacing-md);
    background: var(--color-warning-light);
    border: 1px solid var(--color-warning);
    border-radius: var(--border-radius-sm);
    color: var(--color-warning-dark);

    a {
      color: var(--color-primary);
      font-weight: var(--font-weight-semibold);
      text-decoration: none;

      &:hover {
        text-decoration: underline;
      }
    }
  }
}

.calendly-fallback {
  display: none;
  text-align: center;
  padding: var(--spacing-md);
  margin-top: var(--spacing-md);
  background: var(--color-background-secondary);
  border-radius: var(--border-radius-sm);

  p {
    color: var(--color-text-secondary);
    margin: 0 0 var(--spacing-sm) 0;
    font-size: var(--font-size-sm);
  }

  .calendly-fallback-link {
    display: inline-block;
    padding: var(--spacing-sm) var(--spacing-lg);
    background: var(--color-primary);
    color: white;
    text-decoration: none;
    border-radius: var(--border-radius-md);
    font-weight: var(--font-weight-semibold);
    transition: background-color 0.2s ease;

    &:hover {
      background: var(--color-primary-dark);
    }
  }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

/* Responsive adjustments */
@media (max-width: 768px) {
  .calendly-inline-widget {
    min-height: 500px;
  }

  .calendly-loading {
    height: 300px;
    padding: var(--spacing-md);

    .loading-spinner {
      width: 30px;
      height: 30px;
    }

    p {
      font-size: var(--font-size-sm);
    }
  }
}

/* Dark mode support for Calendly widget */
@media (prefers-color-scheme: dark) {
  .calendly-inline-widget {
    background: var(--color-surface-dark, #1a1a1a);
    border-color: var(--color-border-dark, #333);
  }
}
</style>
