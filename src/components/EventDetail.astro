---
import CalendlyEmbed from './CalendlyEmbed.astro';

export interface Props {
  event: {
    id: string;
    name: string;
    slug: string;
    content: {
      title: string;
      description: string;
      date: string;
      location: string;
      price?: string;
      booking_url?: string;
      image?: {
        filename: string;
        alt?: string;
      };
      tags?: string | string[];
      status?: string;
      max_participants?: number;
      seo_title?: string;
      seo_description?: string;
    };
  };
}

const { event } = Astro.props;

// Normalize tags to always be an array (handles string from Storyblok or array from fallback)
const normalizeTags = (tags: string | string[] | undefined): string[] => {
  if (!tags) return [];
  if (Array.isArray(tags)) return tags;
  if (typeof tags === 'string') return tags.split(',').map(t => t.trim()).filter(Boolean);
  return [];
};

const eventTags = normalizeTags(event.content.tags);

const formatDate = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleDateString('en-SG', {
    weekday: 'long',
    year: 'numeric',
    month: 'long',
    day: 'numeric'
  });
};

const formatTime = (dateString: string) => {
  const date = new Date(dateString);
  return date.toLocaleTimeString('en-SG', {
    hour: '2-digit',
    minute: '2-digit',
    hour12: true
  });
};

const eventDate = new Date(event.content.date);
const isUpcoming = eventDate >= new Date();
const isPast = eventDate < new Date();
---

<article class="event-detail">
  <header class="event-header">
    <div class="event-meta">
      {eventTags.length > 0 && (
        <div class="event-tags">
          {eventTags.map(tag => (
            <span class="tag">{tag}</span>
          ))}
        </div>
      )}
      
      <div class="event-status">
        {isPast && <span class="status past">Past Event</span>}
        {isUpcoming && <span class="status upcoming">Upcoming Event</span>}
      </div>
    </div>

    <h1 class="event-title">{event.content.title}</h1>
    
    <div class="event-summary">
      <div class="event-datetime">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2"/>
          <line x1="16" y1="2" x2="16" y2="6"/>
          <line x1="8" y1="2" x2="8" y2="6"/>
          <line x1="3" y1="10" x2="21" y2="10"/>
        </svg>
        <div>
          <div class="date">{formatDate(event.content.date)}</div>
          <div class="time">{formatTime(event.content.date)}</div>
        </div>
      </div>

      <div class="event-location">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"/>
          <circle cx="12" cy="10" r="3"/>
        </svg>
        <span>{event.content.location}</span>
      </div>

      {event.content.price && (
        <div class="event-price">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"/>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          <span class={event.content.price.toLowerCase() === 'free' ? 'free-price' : 'paid-price'}>
            {event.content.price}
          </span>
        </div>
      )}

      {event.content.max_participants && (
        <div class="event-capacity">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
            <circle cx="9" cy="7" r="4"/>
            <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
            <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
          </svg>
          <span>Limited to {event.content.max_participants} participants</span>
        </div>
      )}
    </div>
  </header>

  <div class="event-content">
    <div class="event-main">
      {event.content.image && (
        <div class="event-image">
          <img 
            src={event.content.image.filename} 
            alt={event.content.image.alt || event.content.title}
            loading="lazy"
          />
        </div>
      )}

      <div class="event-description">
        <h2>About This Event</h2>
        <div class="description-content">
          {event.content.description.split('\n').map(paragraph => (
            paragraph.trim() && <p>{paragraph}</p>
          ))}
        </div>
      </div>

      <div class="event-details-section">
        <h2>Event Details</h2>
        <dl class="details-list">
          <dt>Date & Time</dt>
          <dd>{formatDate(event.content.date)} at {formatTime(event.content.date)}</dd>
          
          <dt>Location</dt>
          <dd>{event.content.location}</dd>
          
          {event.content.price && (
            <>
              <dt>Price</dt>
              <dd class={event.content.price.toLowerCase() === 'free' ? 'free-price' : ''}>{event.content.price}</dd>
            </>
          )}
          
          {event.content.max_participants && (
            <>
              <dt>Capacity</dt>
              <dd>{event.content.max_participants} participants maximum</dd>
            </>
          )}
        </dl>
      </div>
    </div>

    <aside class="event-sidebar">
      <div class="booking-section">
        {isUpcoming && event.content.booking_url ? (
          <div class="booking-card">
            <h3>Reserve Your Spot</h3>
            <p>Secure your place in this event. Limited spaces available!</p>
            
            <a 
              href={event.content.booking_url}
              class="btn btn-primary btn-large"
              target="_blank"
              rel="noopener noreferrer"
            >
              Book Now
            </a>
            
            {event.content.booking_url.includes('calendly') && (
              <div class="calendly-embed-container">
                <CalendlyEmbed url={event.content.booking_url} />
              </div>
            )}
          </div>
        ) : isPast ? (
          <div class="past-event-card">
            <h3>Event Completed</h3>
            <p>This event has already taken place. Check out our upcoming events!</p>
            <a href="/events" class="btn btn-outline">View Upcoming Events</a>
          </div>
        ) : (
          <div class="contact-card">
            <h3>Interested?</h3>
            <p>Contact us for more information about this event.</p>
            <a href="/contacts" class="btn btn-outline">Get in Touch</a>
          </div>
        )}
      </div>

      <div class="related-section">
        <h3>What to Expect</h3>
        <ul class="expectations-list">
          <li>Welcoming and supportive environment</li>
          <li>All skill levels welcome</li>
          <li>Instruments provided during session</li>
          <li>Expert guidance from experienced instructors</li>
          <li>Connect with fellow music enthusiasts</li>
        </ul>
      </div>

      <div class="contact-info">
        <h3>Questions?</h3>
        <p>Need more information about this event?</p>
        <a href="/contacts" class="contact-link">Contact Singapore Handpan Studio</a>
      </div>
    </aside>
  </div>

  <div class="event-actions">
    <a href="/events" class="btn btn-outline">
      ← Back to All Events
    </a>
    
    <div class="share-buttons">
      <span>Share this event:</span>
      <a 
        href={`https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(Astro.url.toString())}`}
        target="_blank"
        rel="noopener noreferrer"
        class="share-btn facebook"
        aria-label="Share on Facebook"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/>
        </svg>
      </a>
      <a 
        href={`https://twitter.com/intent/tweet?url=${encodeURIComponent(Astro.url.toString())}&text=${encodeURIComponent(event.content.title)}`}
        target="_blank"
        rel="noopener noreferrer"
        class="share-btn twitter"
        aria-label="Share on Twitter"
      >
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M23.953 4.57a10 10 0 01-2.825.775 4.958 4.958 0 002.163-2.723c-.951.555-2.005.959-3.127 1.184a4.92 4.92 0 00-8.384 4.482C7.69 8.095 4.067 6.13 1.64 3.162a4.822 4.822 0 00-.666 2.475c0 1.71.87 3.213 2.188 4.096a4.904 4.904 0 01-2.228-.616v.06a4.923 4.923 0 003.946 4.827 4.996 4.996 0 01-2.212.085 4.936 4.936 0 004.604 3.417 9.867 9.867 0 01-6.102 2.105c-.39 0-.779-.023-1.17-.067a13.995 13.995 0 007.557 2.209c9.053 0 13.998-7.496 13.998-13.985 0-.21 0-.42-.015-.63A9.935 9.935 0 0024 4.59z"/>
        </svg>
      </a>
    </div>
  </div>
</article>

<style lang="scss">
@import "src/styles/tokens.scss";

.event-detail {
  max-width: 1000px;
  margin: 0 auto;
}

.event-header {
  margin-bottom: var(--spacing-xxl);
  text-align: center;

  .event-meta {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: var(--spacing-lg);
    margin-bottom: var(--spacing-lg);
    flex-wrap: wrap;
  }

  .event-tags {
    display: flex;
    flex-wrap: wrap;
    gap: var(--spacing-xs);
    justify-content: center;

    .tag {
      background: var(--color-accent-light);
      color: var(--color-accent-dark);
      padding: var(--spacing-xs) var(--spacing-sm);
      border-radius: var(--border-radius-sm);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-medium);
      text-transform: capitalize;
    }
  }

  .event-status {
    .status {
      padding: var(--spacing-xs) var(--spacing-md);
      border-radius: var(--border-radius-md);
      font-size: var(--font-size-sm);
      font-weight: var(--font-weight-semibold);

      &.upcoming {
        background: var(--color-success-light);
        color: var(--color-success-dark);
      }

      &.past {
        background: var(--color-text-secondary);
        color: white;
      }
    }
  }

  .event-title {
    font-size: var(--font-size-xxl);
    font-weight: var(--font-weight-bold);
    color: var(--color-primary);
    margin-bottom: var(--spacing-lg);
    line-height: 1.2;
  }

  .event-summary {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: var(--spacing-md);
    max-width: 800px;
    margin: 0 auto;

    > div {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      padding: var(--spacing-md);
      background: var(--color-surface);
      border-radius: var(--border-radius-md);
      border: 1px solid var(--color-border);

      svg {
        color: var(--color-primary);
        flex-shrink: 0;
      }
    }
  }

  .event-datetime {
    .date {
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
    }
    
    .time {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: 2px;
    }
  }

  .event-price {
    .free-price {
      color: var(--color-success);
      font-weight: var(--font-weight-semibold);
    }

    .paid-price {
      color: var(--color-primary);
      font-weight: var(--font-weight-semibold);
    }
  }
}

.event-content {
  display: grid;
  grid-template-columns: 1fr 300px;
  gap: var(--spacing-xxl);
  margin-bottom: var(--spacing-xxl);

  @media (max-width: 1024px) {
    grid-template-columns: 1fr;
    gap: var(--spacing-xl);
  }
}

.event-main {
  .event-image {
    margin-bottom: var(--spacing-xl);
    border-radius: var(--border-radius-lg);
    overflow: hidden;

    img {
      width: 100%;
      height: 400px;
      object-fit: cover;
    }
  }

  .event-description {
    margin-bottom: var(--spacing-xl);

    h2 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-md);
    }

    .description-content {
      color: var(--color-text-secondary);
      line-height: 1.7;
      font-size: var(--font-size-md);

      p {
        margin-bottom: var(--spacing-md);

        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }

  .event-details-section {
    h2 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-semibold);
      color: var(--color-text-primary);
      margin-bottom: var(--spacing-md);
    }

    .details-list {
      display: grid;
      gap: var(--spacing-md);

      dt {
        font-weight: var(--font-weight-semibold);
        color: var(--color-text-primary);
        margin-bottom: var(--spacing-xs);
      }

      dd {
        color: var(--color-text-secondary);
        margin-bottom: var(--spacing-md);
        padding-left: var(--spacing-md);
        border-left: 3px solid var(--color-accent-light);

        &.free-price {
          color: var(--color-success);
          font-weight: var(--font-weight-semibold);
        }

        &:last-child {
          margin-bottom: 0;
        }
      }
    }
  }
}

.event-sidebar {
  > div {
    margin-bottom: var(--spacing-xl);

    &:last-child {
      margin-bottom: 0;
    }
  }

  h3 {
    font-size: var(--font-size-lg);
    font-weight: var(--font-weight-semibold);
    color: var(--color-text-primary);
    margin-bottom: var(--spacing-md);
  }
}

.booking-card, .past-event-card, .contact-card {
  background: var(--color-surface);
  border: 1px solid var(--color-border);
  border-radius: var(--border-radius-lg);
  padding: var(--spacing-lg);
  text-align: center;

  p {
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-lg);
    line-height: 1.6;
  }

  .btn {
    display: inline-block;
    padding: var(--spacing-md) var(--spacing-xl);
    border-radius: var(--border-radius-md);
    text-decoration: none;
    font-weight: var(--font-weight-semibold);
    transition: all 0.2s ease;
    border: 1px solid transparent;

    &.btn-primary {
      background: var(--color-primary);
      color: white;

      &:hover {
        background: var(--color-primary-dark);
        transform: translateY(-2px);
      }

      &.btn-large {
        padding: var(--spacing-lg) var(--spacing-xxl);
        font-size: var(--font-size-md);
      }
    }

    &.btn-outline {
      color: var(--color-primary);
      border-color: var(--color-primary);
      background: transparent;

      &:hover {
        background: var(--color-primary);
        color: white;
      }
    }
  }
}

.calendly-embed-container {
  margin-top: var(--spacing-lg);
  padding-top: var(--spacing-lg);
  border-top: 1px solid var(--color-border);
}

.related-section {
  .expectations-list {
    list-style: none;
    padding: 0;

    li {
      display: flex;
      align-items: center;
      gap: var(--spacing-sm);
      margin-bottom: var(--spacing-sm);
      color: var(--color-text-secondary);

      &:before {
        content: '✓';
        color: var(--color-success);
        font-weight: var(--font-weight-bold);
        flex-shrink: 0;
      }

      &:last-child {
        margin-bottom: 0;
      }
    }
  }
}

.contact-info {
  background: var(--color-background-secondary);
  padding: var(--spacing-lg);
  border-radius: var(--border-radius-md);
  text-align: center;

  p {
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
  }

  .contact-link {
    color: var(--color-primary);
    text-decoration: none;
    font-weight: var(--font-weight-semibold);

    &:hover {
      text-decoration: underline;
    }
  }
}

.event-actions {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: var(--spacing-xl);
  border-top: 1px solid var(--color-border);

  .btn {
    padding: var(--spacing-sm) var(--spacing-lg);
    border-radius: var(--border-radius-md);
    text-decoration: none;
    font-weight: var(--font-weight-semibold);
    transition: all 0.2s ease;
    border: 1px solid var(--color-primary);
    color: var(--color-primary);
    background: transparent;

    &:hover {
      background: var(--color-primary);
      color: white;
    }
  }

  .share-buttons {
    display: flex;
    align-items: center;
    gap: var(--spacing-sm);

    span {
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
    }

    .share-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      border-radius: 50%;
      text-decoration: none;
      transition: all 0.2s ease;

      &.facebook {
        background: #1877f2;
        color: white;

        &:hover {
          background: #166fe5;
          transform: translateY(-2px);
        }
      }

      &.twitter {
        background: #1da1f2;
        color: white;

        &:hover {
          background: #0d8bd9;
          transform: translateY(-2px);
        }
      }
    }
  }
}

@media (max-width: 768px) {
  .event-header {
    .event-meta {
      flex-direction: column;
      gap: var(--spacing-md);
    }

    .event-title {
      font-size: var(--font-size-xl);
    }

    .event-summary {
      grid-template-columns: 1fr;
      text-align: left;
    }
  }

  .event-actions {
    flex-direction: column;
    gap: var(--spacing-lg);
    align-items: stretch;

    .share-buttons {
      justify-content: center;
    }
  }
}
</style>

